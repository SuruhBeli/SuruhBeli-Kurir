<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kurir - Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Nunito',sans-serif;
  margin:0;
  background:#f8f8f8;
  -webkit-tap-highlight-color: transparent;
}
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  user-select:none;
  -webkit-user-select:none;
  outline:none;
}
/* HEADER */
.header{
  display:flex;
  align-items:center;
  justify-content:center;
  background:#FB923C;
  padding:16px;
}

.header img{
  width:100%;
  max-height:150px;
  object-fit:cover;
  border-radius:12px;
}

/* CARD SUMMARY */
#summaryCard{
  position: relative;
  margin: -10px auto 16px auto;
  max-width: 360px;
  background: #fff;
  padding: 12px 16px;
  border-radius: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  text-align: center;
  font-weight: 700;
  font-size: 16px;
  z-index: 5;
}

/* CONTAINER ORDERS */
.container{
  padding:16px;
  max-width: 400px;
  margin: auto;
}

/* ORDER CARD */
.order-card{
  display:flex;
  align-items:center;
  background:#fff;
  padding:12px;
  margin-bottom:12px;
  border-radius:12px;
  box-shadow:0 4px 10px rgba(0,0,0,0.05);
  gap:12px;
  cursor:pointer;
  transition: transform 0.2s, box-shadow 0.2s;
}

.order-card:hover{
  transform: translateY(-3px);
  box-shadow:0 6px 14px rgba(0,0,0,0.15);
}

.order-card img{
  width:50px;
  height:50px;
  border-radius:50%;
  object-fit:cover;
}

.order-info{
  display:flex;
  flex-direction:column;
}

.order-info .judul{
  font-weight:700;
  font-size:16px;
}

.order-info .layanan{
  font-size:14px;
  color:#555;
}

/* Tombol cek lokasi */
.btn-lokasi {
  margin-left:auto;
  padding:6px 12px;
  background:#10B981;
  color:#fff;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-size:12px;
  font-weight:600;
  transition: background 0.2s, transform 0.2s;
}

.btn-lokasi:hover{
  background:#059669;
  transform: translateY(-2px);
}

/* POPUP OVERLAY */
.popup-overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
  padding:16px;
}

.popup-overlay.show{
  display:flex;
}

.popup-card{
  background:#fff;
  border-radius:16px;
  padding:20px;
  max-width:360px;
  width:100%;
  box-shadow:0 10px 30px rgba(0,0,0,0.1);
}

.popup-card h3{
  margin-bottom:12px;
}

.popup-card p{
  margin:6px 0;
}

.btn-close{
  margin-top:12px;
  width:100%;
  padding:12px;
  border:none;
  border-radius:12px;
  background:#FB923C;
  color:#fff;
  font-weight:700;
  cursor:pointer;
  transition: background 0.2s, transform 0.2s;
}

.btn-close:hover{
  background:#f97316;
  transform: translateY(-2px);
}

/* Loading popup */
#loadingPopup .popup-card{
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  font-size:16px;
  padding:20px;
}

/* ===== EMPTY ANIMASI ===== */
#emptyOrders{
  display:none;
  position:fixed;
  inset:0;
  display:flex;
  justify-content:center;
  align-items:center;
  flex-direction:column;
  z-index:10;
}

.empty-text{
  font-size:18px;
  font-weight:700;
  color:#555;
  display:flex;
  align-items:center;
  gap:8px;
}

/* Lingkaran animasi 3 pulse */
.empty-text span{
  display:block;
  width:10px;
  height:10px;
  background:#FB923C;
  border-radius:50%;
  animation: pulse 1.5s infinite;
}

.empty-text span:nth-child(1){ animation-delay: 0s; }
.empty-text span:nth-child(2){ animation-delay: 0.3s; }
.empty-text span:nth-child(3){ animation-delay: 0.6s; }

@keyframes pulse{
  0% { transform: scale(0); opacity:1; }
  50% { transform: scale(1.5); opacity:0.5; }
  100% { transform: scale(0); opacity:0; }
}
</style>
</head>
<body>

<div class="header">
  <img id="headerFoto" src="default.png" alt="Header">
</div>

<div id="summaryCard">Memuat data...</div>

<div class="container" id="ordersContainer">
  <!-- Orders akan ditampilkan di sini -->
</div>

<!-- Animasi Menunggu Pesanan -->
<div id="emptyOrders">
  <div class="empty-text">
    Menunggu pesanan
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<!-- POPUP DETAIL ORDER -->
<div class="popup-overlay" id="orderPopup">
  <div class="popup-card" id="popupCard">
    <h3 id="popupJudul">Judul Pesanan</h3>
    <p><strong>Pesanan:</strong> <span id="popupPesanan">-</span></p>
    <p><strong>Catatan:</strong> <span id="popupCatatan">-</span></p>
    <p><strong>Beli di:</strong> <span id="popupBeliDi">-</span></p>
    <button class="btn-close" id="btnAmbil">Ambil</button>
  </div>
</div>

<!-- POPUP LOADING & NOTIF -->
<div class="popup-overlay" id="loadingPopup">
  <div class="popup-card">
    <h3 id="loadingText">Sedang memproses...</h3>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
<script>
// ================= FIREBASE CONFIG =================
firebase.initializeApp({
  apiKey: "AIzaSyByQl0BXZoSMzrULUNA6l7UVFQjXmvsdJE",
  authDomain: "suruhbeli-e8ae8.firebaseapp.com",
  projectId: "suruhbeli-e8ae8"
});

const db = firebase.firestore();
const auth = firebase.auth();

let currentUser = null;
let selectedOrderId = null;
let selectedOrderData = null;

// CEK LOGIN
auth.onAuthStateChanged(async user => {
  if(user){
    currentUser = user;

    // cek kurir
    const kurirDoc = await db.collection("kurir").doc(user.uid).get();
    if(!kurirDoc.exists){
      alert("Anda bukan kurir, akses ditolak");
      auth.signOut();
      return;
    }

    loadHeaderFoto();
    loadOrders();
  } else {
    window.location.href = "login.html";
  }
});

// LOAD HEADER FOTO
async function loadHeaderFoto(){
  try{
    const doc = await db.collection("stockfoto").doc("headerhomekurir").get();
    if(doc.exists && doc.data().headerhomekurir){
      document.getElementById("headerFoto").src = doc.data().headerhomekurir;
    }
  } catch(e){ console.error(e); }
}

// LOAD ORDERS
async function loadOrders(){
  const ordersContainer = document.getElementById("ordersContainer");
  const emptyOrders = document.getElementById("emptyOrders");
  ordersContainer.innerHTML = "";

  const summaryCard = document.getElementById("summaryCard");

  const snapshot = await db.collection("orders").where("status","==","Dibuat").get();

  if(snapshot.empty){
    ordersContainer.style.display = "none";
    emptyOrders.style.display = "flex";
    summaryCard.innerText = "Belum ada pesanan masuk";
  } else {
    ordersContainer.style.display = "block";
    emptyOrders.style.display = "none";
    summaryCard.innerText = `Pesanan: ${snapshot.size}`;
  }

  snapshot.forEach(doc=>{
    const data = doc.data();
    const card = document.createElement("div");
    card.classList.add("order-card");

    const img = document.createElement("img");
    img.src = "https://i.pravatar.cc/50?u="+doc.id;

    const info = document.createElement("div");
    info.classList.add("order-info");

    const judul = document.createElement("div");
    judul.classList.add("judul");
    judul.innerText = data.judul||"Pesanan Baru";

    const layanan = document.createElement("div");
    layanan.classList.add("layanan");
    layanan.innerText = data.layanan||"-";

    info.appendChild(judul);
    info.appendChild(layanan);
    card.appendChild(img);
    card.appendChild(info);

    const btnLokasi = document.createElement("button");
    btnLokasi.classList.add("btn-lokasi");
    btnLokasi.innerText = "Cek Lokasi";
    btnLokasi.addEventListener("click", e=>{
      e.stopPropagation();
      if(data.lat && data.lng){
        window.open(`https://www.google.com/maps/search/?api=1&query=${data.lat},${data.lng}`,"_blank");
      } else { showCustomPopup("Lokasi belum tersedia!"); }
    });
    card.appendChild(btnLokasi);

    card.addEventListener("click", ()=>{
      selectedOrderId = doc.id;
      selectedOrderData = data;
      document.getElementById("popupJudul").innerText = data.layanan||"-";
      document.getElementById("popupPesanan").innerText = data.pesanan||"-";
      document.getElementById("popupCatatan").innerText = data.catatan||"-";
      document.getElementById("popupBeliDi").innerText = data.beliDi||"-";
      document.getElementById("orderPopup").classList.add("show");
    });

    ordersContainer.appendChild(card);
  });
}

// POPUP CUSTOM
function showCustomPopup(msg){
  const loading = document.getElementById("loadingPopup");
  const loadingText = document.getElementById("loadingText");
  loadingText.innerText = msg;
  loading.classList.add("show");
  setTimeout(()=> loading.classList.remove("show"),1500);
}

// CLOSE POPUP
function closePopup(){
  document.getElementById("orderPopup").classList.remove("show");
}
document.getElementById("orderPopup").addEventListener("click", e=>{
  if(e.target.id==="orderPopup") closePopup();
});

// TOMBOL AMBIL
document.getElementById("btnAmbil").addEventListener("click", async ()=>{
  if(!selectedOrderId||!currentUser) return;
  const loading=document.getElementById("loadingPopup");
  const loadingText=document.getElementById("loadingText");
  loadingText.innerText="Sedang memproses...";
  loading.classList.add("show");

  try{
    const kurirDoc=await db.collection("kurir").doc(currentUser.uid).get();
    const noKurir=kurirDoc.exists?kurirDoc.data().noHP:"";
    await db.collection("orders").doc(selectedOrderId).update({
      status:"Diproses",
      kurir: currentUser.uid,
      noKurir:noKurir
    });
    loadingText.innerText="Pesanan berhasil diambil!";
    setTimeout(()=>{
      loading.classList.remove("show");
      closePopup();
      window.location.href="tugas.html";
    },1000);
  } catch(e){
    console.error(e);
    loadingText.innerText="Gagal mengambil pesanan!";
    setTimeout(()=>loading.classList.remove("show"),2000);
  }
});
</script>
</body>
</html>